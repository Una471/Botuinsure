<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotsuInsure Admin | PDF Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1e3c72; --secondary: #2a5298; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: var(--primary) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .upload-area { border: 2px dashed #cbd5e0; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; background: white; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #f8faff; }
        .loader { display: none; }
        .extracted-form { display: none; padding: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i> BotsuInsure Admin Dashboard</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card p-4 text-center" id="uploadCard">
                <h4><i class="fas fa-file-pdf text-danger me-2"></i> Insurance PDF Parser</h4>
                <p class="text-muted">Upload brochures (PulaMed, BPOMAS, etc.) to extract data automatically.</p>
                
                <div class="upload-area" id="dropZone" onclick="document.getElementById('pdfInput').click()">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                    <h5>Click to upload PDF brochure</h5>
                    <p class="text-muted small mb-0">Maximum file size: 4MB</p>
                    <input type="file" id="pdfInput" hidden accept=".pdf">
                </div>

                <div class="mt-3">
                    <div class="alert alert-info p-2 small">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>File Size Limit: 4MB</strong> - For larger files, use 
                        <a href="https://www.ilovepdf.com/compress_pdf" target="_blank" class="alert-link">ilovepdf.com</a> 
                        to compress first.
                    </div>
                </div>

                <div class="loader mt-4" id="mainLoader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 fw-bold text-primary">AI is reading the PDF... please wait.</p>
                </div>
            </div>

            <div class="card extracted-form" id="reviewCard">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0 text-primary">Review Extracted Data</h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">Cancel</button>
                </div>
                <form id="insuranceForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Name (Product Name)</label>
                            <input type="text" class="form-control" name="Name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Company Name</label>
                            <input type="text" class="form-control" name="Company Name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Category</label>
                            <select class="form-select" name="Category">
                                <option value="medical">medical</option>
                                <option value="life">life</option>
                                <option value="funeral">funeral</option>
                                <option value="health">health</option>
                                <option value="property">property</option>
                                <option value="liability">liability</option>
                                <option value="workers_compensation">workers_compensation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Sum Assured</label>
                            <input type="text" class="form-control" name="Sum Assured">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Annual Limit</label>
                            <input type="number" class="form-control" name="Annual Limit">
                        </div>
                        <div class="col-md-4 text-success">
                            <label class="form-label fw-bold">Basic Price (Monthly)</label>
                            <input type="number" class="form-control" name="Basic Price">
                        </div>
                        <div class="col-md-4 text-primary">
                            <label class="form-label fw-bold">Standard Price (Monthly)</label>
                            <input type="number" class="form-control" name="Standard Price">
                        </div>
                        <div class="col-md-4 text-warning">
                            <label class="form-label fw-bold">Premium Price (Monthly)</label>
                            <input type="number" class="form-control" name="Premium Price">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Key Features</label>
                            <textarea class="form-control" name="Key Features" rows="3"></textarea>
                        </div>
                    </div>
                    <hr class="my-4">
                    <button type="submit" class="btn btn-success w-100 py-3 fw-bold">
                        <i class="fas fa-check-circle me-2"></i> SAVE AND APPROVE TO AIRTABLE
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        PDF_PARSER_ENDPOINT: "https://botuinsure.vercel.app/api/parse-insurance-pdf", 
        AIRTABLE_TOKEN: "pat3O0ibg4EKppGFd.404fe41eea77ee6e66e2d8e72179250447c20021f4aed351a51134c04d6a4cdb",
        AIRTABLE_BASE_ID: "appyCd1RKcaY8q1We",
        AIRTABLE_TABLE: "Products"
    };

    const pdfInput = document.getElementById('pdfInput');
    const mainLoader = document.getElementById('mainLoader');
    const reviewCard = document.getElementById('reviewCard');
    const uploadCard = document.getElementById('uploadCard');

    // PDF Compression Function
    async function compressPDF(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const base64Data = e.target.result;
                    const base64Content = base64Data.split(',')[1];
                    
                    // Simple compression: remove whitespace from base64
                    const compressed = base64Content.replace(/\s+/g, '');
                    resolve(compressed);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Function to handle very large PDFs by extracting first part
    async function handleLargePDF(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const base64Data = e.target.result;
                    const base64Content = base64Data.split(',')[1];
                    
                    // Take only first 3MB of base64 data (approx 2MB of PDF)
                    // This extracts roughly the first 10-15 pages
                    const maxBase64Size = 3 * 1024 * 1024 * 0.75; // 3MB in base64
                    const partialContent = base64Content.substring(0, maxBase64Size);
                    
                    console.log(`Large PDF: Taking first ${partialContent.length} chars of ${base64Content.length} total`);
                    resolve(partialContent);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    pdfInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Show file size info
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        console.log(`Selected PDF: ${file.name}, Size: ${fileSizeMB}MB`);

        // Check file size - Vercel has 4.5MB limit
        const MAX_SIZE_MB = 4.0; // Stay under 4MB to be safe
        
        if (file.size > MAX_SIZE_MB * 1024 * 1024) {
            const userChoice = confirm(
                `‚ö†Ô∏è PDF is ${fileSizeMB}MB (Maximum: 4MB)\n\n` +
                `This file is too large for direct upload.\n` +
                `Do you want to:\n\n` +
                `‚Ä¢ OK = Extract first part only (recommended)\n` +
                `‚Ä¢ Cancel = Upload a smaller PDF`
            );
            
            if (!userChoice) {
                alert('Upload cancelled. Please use a PDF under 4MB.');
                pdfInput.value = '';
                return;
            }
        }

        mainLoader.style.display = 'block';
        
        try {
            // Show appropriate message
            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                mainLoader.innerHTML = `
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 fw-bold text-primary">
                        Processing large PDF (${fileSizeMB}MB)...<br>
                        <small>Extracting first part for analysis</small>
                    </p>
                `;
            } else {
                mainLoader.innerHTML = `
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 fw-bold text-primary">
                        Processing PDF (${fileSizeMB}MB)...<br>
                        <small>This may take a moment</small>
                    </p>
                `;
            }

            let finalBase64;
            
            // Choose processing method based on size
            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                // Large file: extract first part only
                finalBase64 = await handleLargePDF(file);
                const processedSizeKB = Math.floor(finalBase64.length * 3 / 4 / 1024);
                console.log(`Large PDF: Using ${processedSizeKB}KB of ${fileSizeMB}MB`);
            } else {
                // Normal file: compress it
                finalBase64 = await compressPDF(file);
                const compressedSizeKB = Math.floor(finalBase64.length * 3 / 4 / 1024);
                console.log(`Normal PDF: Compressed to ${compressedSizeKB}KB`);
            }

            // Update loader message
            mainLoader.innerHTML = `
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 fw-bold text-primary">
                    AI is analyzing the PDF...<br>
                    <small>Please wait while AI extracts data</small>
                </p>
            `;

            // Send to API
const res = await fetch(CONFIG.PDF_PARSER_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
        content: finalBase64,
        filename: file.name,
        originalSize: file.size
    })
});

// Handle response
if (!res.ok) {
    let errorText;
    try {
        errorText = await res.text();
        console.error('Server error:', res.status, errorText);
        
        // Try to parse as JSON for better error messages
        try {
            const errorJson = JSON.parse(errorText);
            if (errorJson.error) {
                throw new Error(`Server error ${res.status}: ${errorJson.error}`);
            }
            if (errorJson.debug) {
                throw new Error(`Server error ${res.status}: ${errorJson.error || 'Unknown error'}\nDebug: ${errorJson.debug}`);
            }
        } catch {
            // Not JSON, use text as is
        }
        
        if (res.status === 413) {
            throw new Error(
                `‚ùå PDF is too large even after processing.\n\n` +
                `Original: ${fileSizeMB}MB\n\n` +
                `üìå Please:\n` +
                `1. Compress at ilovepdf.com to under 3MB\n` +
                `2. Extract only first 5 pages\n` +
                `3. Try a different PDF file`
            );
        }
        throw new Error(`Server error ${res.status}: ${errorText.substring(0, 200)}`);
    } catch (textError) {
        throw new Error(`Server error ${res.status}: Failed to read response`);
    }
}
            
            const result = await res.json();
            
            if (result.success) {
                fillForm(result.data);
                uploadCard.style.display = 'none';
                reviewCard.style.display = 'block';
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ Successfully parsed PDF!\n\nüìÑ ${file.name}\nüìè ${fileSizeMB}MB\n‚ú® Data extracted and ready for review.`);
                }, 500);
            } else {
                let errorMsg = "‚ùå AI Extraction Error: " + (result.error || "Unknown error");
                if (result.debug) {
                    errorMsg += "\n\nüîç " + result.debug;
                }
                alert(errorMsg);
                console.error('PDF parsing failed:', result);
            }
        } catch (err) {
            console.error('Upload error:', err);
            alert("‚ùå Failed to process PDF:\n\n" + err.message);
        } finally {
            mainLoader.style.display = 'none';
            // Reset loader text
            mainLoader.innerHTML = `
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 fw-bold text-primary">AI is reading the PDF... please wait.</p>
            `;
        }
    };

    function fillForm(data) {
        const form = document.getElementById('insuranceForm');
        for (let key in data) {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) input.value = data[key];
        }
    }

    document.getElementById('insuranceForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const record = Object.fromEntries(formData.entries());
        record.ID = Math.floor(Date.now() / 1000);

        try {
            const res = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${CONFIG.AIRTABLE_TABLE}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fields: record })
            });

            if (res.ok) {
                alert("‚úÖ Added to Airtable!");
                location.reload();
            } else {
                const error = await res.json();
                alert("Airtable Error: " + error.error.message);
            }
        } catch (err) {
            alert("Failed to save.");
        }
    };
</script>
</body>
</html>